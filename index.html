<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>읽고 쓰고 떠나자!</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net"/>
<!-- Lucide 아이콘 -->
<script src="https://unpkg.com/lucide@0.469.0/dist/umd/lucide.min.js"></script>
<style>
  :root{
    --bg:#ffffff; --tx:#0b1020; --mut:#6b7280; --line:#e5e7eb;
    --primary:#0b1020; --primary-fore:#fff;
    --card:#f7f7fb; --soft:#f2f4f8;
    --accent:#111827; --accent-fore:#fff;
    --radius:16px;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--tx);font-family:ui-sans-serif,system-ui,"Apple SD Gothic Neo","Noto Sans KR",sans-serif}
  .wrap{max-width:420px;margin:0 auto;min-height:100%;padding-bottom:92px}
  /* 헤더 */
  header{position:sticky;top:0;z-index:20;background:var(--bg);
    border-bottom:1px solid var(--line)}
  .head-inner{display:flex;align-items:center;justify-content:center;padding:18px 16px}
  .title{font-weight:800;letter-spacing:-.02em;font-size:22px}

  /* 공통 패널 */
  .panel{background:#fff;border:1px solid var(--line);border-radius:var(--radius);padding:16px}
  .section{padding:16px}
  h2{margin:0 0 12px;font-size:18px}
  .mut{color:var(--mut);font-size:13px}

  /* 입력 */
  .input{width:100%;border:1px solid var(--line);border-radius:12px;padding:12px 14px;background:#fff;color:var(--tx);font-size:14px}
  .textarea{width:100%;border:1px solid var(--line);border-radius:12px;padding:12px 14px;background:#fff;color:var(--tx);font-size:14px;min-height:120px;resize:vertical}

  /* 타이머 카드 */
  .timer-card{display:flex;flex-direction:column;align-items:center;gap:14px;
    background:var(--card);border:1px solid var(--line);border-radius:22px;padding:24px 16px}
  .clock{font-weight:900;font-size:48px;letter-spacing:.02em}
  .btnrow{display:flex;gap:10px;flex-wrap:wrap}
  .btn{border:1px solid var(--line);background:#fff;color:var(--tx);border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
  .btn.primary{background:var(--primary);color:var(--primary-fore);border-color:var(--primary)}
  .btn.ghost{background:#f3f4f6}
  .stack{display:flex;flex-direction:column;gap:12px}

  /* 카드 도감 그리드 */
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
  .slot{aspect-ratio:3/4;background:#eef1f6;border:1px dashed #d1d5db;border-radius:14px;
    display:grid;place-items:center;overflow:hidden;color:#9aa3af;font-weight:800;font-size:36px}
  .slot img{width:100%;height:100%;object-fit:cover}

  /* 피드 */
  .feed{display:flex;flex-direction:column;gap:10px}
  .feed-item{border:1px dashed #d1d5db;background:#fafafa;padding:12px;border-radius:12px}

  /* 하단 네비 */
  .bottom{position:fixed;left:50%;transform:translateX(-50%);bottom:0;width:100%;max-width:420px;
    background:#fff;border-top:1px solid var(--line)}
  .tabs{display:grid;grid-template-columns:repeat(4,1fr);gap:4px;padding:10px}
  .tab{display:flex;flex-direction:column;align-items:center;gap:4px;padding:10px 6px;border-radius:12px;color:var(--mut);font-size:12px;border:1px solid transparent;background:transparent}
  .tab.active{background:#0b1020;color:#fff;border-color:#0b1020}
  .hidden{display:none!important}

  /* 상단 여백(섹션 헤더 느낌) */
  .section > .caption{font-size:16px;font-weight:800;margin-bottom:12px}

  /* 관리자 카드 */
  .admin-grid{display:flex;flex-direction:column;gap:10px}
</style>
</head>
<body>
<div class="wrap">
  <!-- 헤더 -->
  <header>
    <div class="head-inner">
      <div class="title">읽고 쓰고 떠나자!</div>
    </div>
  </header>

  <!-- ============ 기록 탭 ============ -->
  <section id="tab-app" class="section">
    <div class="stack">
      <div class="panel">
        <h2>기록</h2>
        <input id="bookTitle" class="input" type="text" placeholder="책 제목을 입력하세요"/>
        <div class="timer-card" style="margin-top:14px">
          <div id="time" class="clock">00:00:00</div>
          <div class="btnrow">
            <button id="btnStart" class="btn primary">시작</button>
            <button id="btnPause" class="btn">일시정지</button>
            <button id="btnSave" class="btn ghost">종료</button>
          </div>
        </div>
        <!-- 최근 기록 목록(유저가 저장할 때만 JS가 채움) -->
        <div id="logs" class="feed" style="margin-top:12px"></div>
      </div>
    </div>
  </section>

  <!-- ============ 카드 도감 탭 ============ -->
  <section id="tab-cards" class="section hidden">
    <div class="panel">
      <h2>카드 도감</h2>
      <div id="dexGrid" class="grid"></div>
      <p class="mut" style="margin-top:10px">스페셜 카드는 오프라인 위치 인증 후 활성화됩니다.</p>
      <button id="btnClaimSpecial" class="btn" style="margin-top:10px;width:100%">여행 완료(위치 인증)</button>
    </div>
  </section>

  <!-- ============ 비밀 공간(문장 여행) ============ -->
  <section id="tab-trip" class="section hidden">
    <div class="stack">
      <div class="panel">
        <h2>우리끼리만 공유해요</h2>
        <textarea id="tripInput" class="textarea" placeholder="책 제목, 작가명 등 정확한 정보를 함께 입력해야 합니다."></textarea>
        <button id="btnTripSend" class="btn primary" style="margin-top:10px;width:100%">여행 보내기</button>
        <p class="mut" style="margin-top:10px">공유된 문장은 관리자 승인 후 표시됩니다.</p>
      </div>
      <div class="panel">
        <h2>승인된 문장</h2>
        <div id="approvedList" class="feed"></div>
      </div>
    </div>
  </section>

  <!-- ============ 관리자 ============ -->
  <section id="tab-admin" class="section hidden">
    <div class="stack">
      <div class="panel">
        <h2>관리자 로그인</h2>
        <input id="adminPass" class="input" type="password" placeholder="비밀번호 (예: 0000)"/>
        <button id="btnAdminLogin" class="btn primary" style="margin-top:10px;width:100%">로그인</button>
        <div id="adminError" class="mut" style="margin-top:8px"></div>
      </div>

      <div id="adminPanel" class="panel hidden">
        <h2>승인 대기</h2>
        <div id="pendingList" class="admin-grid"></div>
      </div>
    </div>
  </section>

  <!-- 하단 네비게이션 -->
  <nav class="bottom">
    <div class="tabs">
      <button class="tab active" data-tab="app">
        <i data-lucide="book-open" width="20" height="20"></i>
        <span>기록</span>
      </button>
      <button class="tab" data-tab="cards">
        <i data-lucide="album" width="20" height="20"></i>
        <span>카드 도감</span>
      </button>
      <button class="tab" data-tab="trip">
        <i data-lucide="lock" width="20" height="20"></i>
        <span>비밀 공간</span>
      </button>
      <button class="tab" data-tab="admin">
        <i data-lucide="settings" width="20" height="20"></i>
        <span>관리</span>
      </button>
    </div>
  </nav>
</div>

<!-- ===== 기능 스크립트 (기존 로직 유지) ===== -->
<script>
  // 하단 네비 탭 전환
  document.querySelectorAll('.tab').forEach(btn=>{
    btn.onclick=()=>{
      document.querySelectorAll('section').forEach(s=>s.classList.add('hidden'));
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      btn.classList.add('active');
      const id = btn.dataset.tab;
      document.querySelector('#tab-'+id).classList.remove('hidden');
      if(window.lucide) window.lucide.createIcons(); // 아이콘 재렌더
    };
  });
  // 초기 아이콘 렌더
  if(window.lucide) window.lucide.createIcons();
</script>

<!-- ===== Firebase SDK & Firestore 로직 (원본 기능) ===== -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
  import {
    getFirestore, collection, addDoc, getDocs, query, where, deleteDoc, doc, updateDoc
  } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

  // ✅ 기존 구성 사용 (민감값은 그대로)
  const firebaseConfig = {
    apiKey: "AIzaSyCtTLSrv6mhtOldWLu_qWwNt7uHHvGRNto",
    authDomain: "lostn-89a2f.firebaseapp.com",
    projectId: "lostn-89a2f",
    storageBucket: "lostn-89a2f.firebasestorage.app",
    messagingSenderId: "219937021272",
    appId: "1:219937021272:web:8f240b170a557d0224592d",
    measurementId: "G-V7891ZWWVF"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ===== 타이머(시작/일시정지/종료=저장) =====
  let timerInt=null, acc=0, startT=0;
  const timeEl = document.getElementById("time");
  const bookEl = document.getElementById("bookTitle");
  const logsEl = document.getElementById("logs");

  function renderTime(ms){
    const s=Math.floor(ms/1000);
    const h=Math.floor(s/3600), m=Math.floor((s%3600)/60), sec=s%60;
    timeEl.textContent = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
  }
  function pushLog(book,ms){
    // UI만 간단 기록(예시 미삽입 원칙 유지: 저장 시에만 생성)
    const item=document.createElement("div");
    item.className="feed-item";
    item.innerHTML=`<strong>${book||"무제"}</strong><div class="mut">${Math.floor(ms/60000)}분 ${Math.floor((ms%60000)/1000)}초</div>`;
    logsEl.prepend(item);
  }
  document.getElementById("btnStart").onclick=()=>{
    if(timerInt) return;
    startT = Date.now();
    timerInt = setInterval(()=>{ renderTime(acc + Date.now()-startT); }, 250);
  };
  document.getElementById("btnPause").onclick=()=>{
    if(!timerInt) return;
    acc += Date.now() - startT;
    clearInterval(timerInt); timerInt=null;
  };
  document.getElementById("btnSave").onclick=()=>{
    if(timerInt){ acc += Date.now()-startT; clearInterval(timerInt); timerInt=null; }
    if(acc>0){ pushLog(bookEl.value.trim(), acc); }
    acc=0; renderTime(0);
  };
  renderTime(0);

  // ===== 카드 도감 10칸(이미지 없으면 ? 표시) =====
  const dexGrid=document.getElementById("dexGrid");
  function renderDex(){
    if(!dexGrid) return;
    dexGrid.innerHTML="";
    for(let i=1;i<=9;i++){
      const slot=document.createElement("div"); slot.className="slot";
      // 이미지가 있으면 사용, 없으면 '?'
      const img=new Image(); img.src="/images/day"+i+".jpg"; img.alt="day"+i;
      img.onload=()=>{ slot.innerHTML=""; slot.appendChild(img); };
      img.onerror=()=>{ slot.textContent="?"; };
      slot.appendChild(document.createTextNode("")); // 초기 비움
      dexGrid.appendChild(slot);
    }
    // 스페셜
    const spec=document.createElement("div"); spec.className="slot";
    const simg=new Image(); simg.src="/images/specialcard.jpg"; simg.onload=()=>{ spec.innerHTML=""; spec.appendChild(simg); };
    simg.onerror=()=>{ spec.textContent="?"; };
    spec.appendChild(document.createTextNode(""));
    dexGrid.appendChild(spec);
  }
  renderDex();

  // ===== 위치 인증(동대구역 반경 300m) =====
  const claimBtn = document.getElementById("btnClaimSpecial");
  if(claimBtn){
    claimBtn.onclick=()=>{
      if(!navigator.geolocation){ alert("GPS 지원 안됨"); return; }
      navigator.geolocation.getCurrentPosition(pos=>{
        const {latitude:lat, longitude:lng} = pos.coords;
        const targetLat=35.879388797, targetLng=128.628366313;
        const dist = getDistance(lat,lng,targetLat,targetLng);
        if(dist<=300) alert("위치 인증 성공! 대구 도착! 이제 당신의 키링을 만나보세요");
        else alert("위치 인증 실패: 동대구역 반경 300m 이내에서만 인증 가능합니다.");
      },()=>alert("위치 확인 불가"));
    };
  }
  function getDistance(lat1,lng1,lat2,lng2){
    const R=6371e3, toRad=x=>x*Math.PI/180;
    const φ1=toRad(lat1), φ2=toRad(lat2);
    const Δφ=toRad(lat2-lat1), Δλ=toRad(lng2-lng1);
    const a=Math.sin(Δφ/2)**2 + Math.cos(φ1)*Math.cos(φ2)*Math.sin(Δλ/2)**2;
    return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  }

  // ===== 문장 여행(작성) & 승인 문장 표시 =====
  const userId = new URLSearchParams(location.search).get("id") || "anon";
  const tripBtn = document.getElementById("btnTripSend");
  if(tripBtn){
    tripBtn.onclick = async()=>{
      const text = document.getElementById("tripInput").value.trim();
      if(!text){ alert("문장을 입력하세요"); return; }
      await addDoc(collection(db,"sentences"),{
        id:userId, text, status:"pending", createdAt:new Date().toISOString(), isNotified:false
      });
      alert("승인 시 키링으로 제작되어 먼저 대구 여행 가 있을게요! 승인 or 반려는 2일 이내에 안내드립니다");
      document.getElementById("tripInput").value="";
    };
  }

  async function renderApproved(){
    const approvedDiv=document.getElementById("approvedList");
    if(!approvedDiv) return;
    const qSnap=await getDocs(query(collection(db,"sentences"),where("status","==","approved")));
    approvedDiv.innerHTML="";
    qSnap.forEach(docSnap=>{
      const d=docSnap.data();
      const el=document.createElement("div");
      el.className="feed-item";
      el.innerHTML = `${d.text}<div class="mut">작성자: ${d.id}</div>`;
      approvedDiv.appendChild(el);
    });
  }
  renderApproved();

  // 접속 시 내 문장이 승인됐는지 알림(한 번만)
  async function checkMyApproval(){
    if(!userId || userId==="anon") return;
    const qSnap=await getDocs(query(collection(db,"sentences"),where("id","==",userId)));
    qSnap.forEach(async(docSnap)=>{
      const d=docSnap.data();
      if(d.status==="approved" && !d.isNotified){
        alert(`✅ 승인된 문장: ${d.text}`);
        await updateDoc(doc(db,"sentences",docSnap.id),{isNotified:true});
      }
    });
  }
  checkMyApproval();

  // ===== 관리자(비번 0000) =====
  const adminBtn = document.getElementById("btnAdminLogin");
  if(adminBtn){
    adminBtn.onclick = async()=>{
      const pass = document.getElementById("adminPass").value;
      if(pass!=="0000"){ document.getElementById("adminError").textContent="비밀번호가 올바르지 않습니다."; return; }
      document.getElementById("adminPanel").classList.remove("hidden");
      loadPending();
    };
  }
  async function loadPending(){
    const list=document.getElementById("pendingList");
    const qSnap=await getDocs(query(collection(db,"sentences"),where("status","==","pending")));
    list.innerHTML="";
    qSnap.forEach(docSnap=>{
      const d=docSnap.data();
      const item=document.createElement("div");
      item.className="feed-item";
      item.innerHTML = `
        ${d.text}
        <div class="mut">작성자: ${d.id}</div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button data-id="${docSnap.id}" class="btn ghost btnReject">반려</button>
          <button data-id="${docSnap.id}" class="btn primary btnApprove">승인</button>
        </div>`;
      list.appendChild(item);
    });
    list.querySelectorAll(".btnReject").forEach(b=>{
      b.onclick=async()=>{ await deleteDoc(doc(db,"sentences",b.dataset.id)); loadPending(); };
    });
    list.querySelectorAll(".btnApprove").forEach(b=>{
      b.onclick=async()=>{
        await updateDoc(doc(db,"sentences",b.dataset.id),{status:"approved"});
        loadPending(); renderApproved();
      };
    });
  }
</script>
</body>
</html>
