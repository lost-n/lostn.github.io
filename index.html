<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>읽고 쓰고 떠나자!</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
:root{
  --bg:#0f1115;--p1:#171a21;--p2:#1e2230;--tx:#e9ecf1;--mut:#a7b0c3;
  --ac:#6aa8ff;--good:#7bd88f;--bad:#ff7b7b;
  --card:#262b3a;--br:#31384a;
}
*{box-sizing:border-box}
body{margin:0;background:#0c101a;color:var(--tx);font-family:"Noto Sans KR",sans-serif}
.wrap{max-width:1200px;margin:28px auto;padding:0 16px}
header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
.tabs{display:flex;gap:8px}
.tab{background:transparent;border:1px solid #2b3144;color:var(--mut);padding:8px 12px;border-radius:10px;cursor:pointer}
.tab.active{background:var(--ac);color:#081220}
.panel{background:var(--p1);border:1px solid #222839;border-radius:16px;padding:16px;margin-bottom:14px}
h2{font-size:16px;margin:0 0 12px}
input[type="text"], textarea{width:100%;background:var(--p2);color:var(--tx);border:1px solid #2b3144;border-radius:10px;padding:10px}
button{background:var(--ac);color:#081220;border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
.time{font-size:40px;font-weight:700;padding:10px 14px;background:#121521;border-radius:12px;border:1px solid #242a3c;text-align:center}
.dex-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
.slot{aspect-ratio:3/4;background:var(--card);border:1px dashed var(--br);border-radius:12px;display:grid;place-items:center;overflow:hidden}
.slot img{width:100%;height:100%;object-fit:cover}
.notice{font-size:12px;color:#a7b0c3;margin-top:6px}
.feed{display:flex;flex-direction:column;gap:10px}
.feed-item{border:1px dashed #2b3144;background:#121521;padding:10px;border-radius:12px}
.hidden{display:none!important}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>읽고 쓰고 떠나자!</h1>
    <div class="tabs">
      <button class="tab active" data-tab="app">독서 기록</button>
      <button class="tab" data-tab="trip">문장 여행</button>
      <button class="tab" data-tab="admin">관리자</button>
    </div>
  </header>

  <!-- 독서 기록 -->
  <section id="tab-app">
    <div class="panel">
      <h2>오늘은 어떤 책을 얼마나 읽을까요?</h2>
      <input id="bookTitle" type="text" placeholder="책 제목을 입력하세요"/>
      <div style="margin-top:10px;display:flex;gap:10px;align-items:center">
        <div class="time" id="time">00:00:00</div>
        <button id="btnStart">시작</button>
        <button id="btnPause">일시정지</button>
        <button id="btnSave">기록 저장</button>
      </div>
      <div class="logs" id="logs"></div>
    </div>

    <div class="panel">
      <h2>여행지 카드 도감</h2>
      <div class="dex-grid" id="dexGrid"></div>
      <div class="notice">마지막 카드는 여행과 함께 찾아와요!</div>
      <button id="btnClaimSpecial">여행 완료</button>
    </div>
  </section>

  <!-- 문장 여행 -->
  <section id="tab-trip" class="hidden">
    <div class="panel">
      <h2>좋아하는 책 문장을 공유하면 키링으로 태어나요!</h2>
      <textarea id="tripInput" placeholder="책 제목, 작가명 등 출처를 함께 적어야 합니다. 욕설, 비방, 책 문장이 아닌 글 등을 공유 시 승인되지 않을 수 있습니다."></textarea>
      <button id="btnTripSend">여행 보내기</button>
    </div>
    <div class="panel">
      <h2>승인된 문장 게시판</h2>
      <div id="approvedList"></div>
    </div>
  </section>

  <!-- 관리자 -->
  <section id="tab-admin" class="hidden">
    <div class="panel">
      <h2>관리자 로그인</h2>
      <input id="adminPass" type="password" placeholder="비밀번호"/>
      <button id="btnAdminLogin">로그인</button>
      <div id="adminError" class="notice"></div>
    </div>
    <div class="panel hidden" id="adminPanel">
      <h2>문장 관리</h2>
      <div id="pendingList"></div>
    </div>
  </section>
</div>

<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
import { 
  getFirestore, collection, addDoc, getDocs, query, where, deleteDoc, doc, updateDoc 
} from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

// ✅ 실제 firebaseConfig 값
const firebaseConfig = {
  apiKey: "AIzaSyCtTLSrv6mhtOldWLu_qWwNt7uHHvGRNto",
  authDomain: "lostn-89a2f.firebaseapp.com",
  projectId: "lostn-89a2f",
  storageBucket: "lostn-89a2f.firebasestorage.app",
  messagingSenderId: "219937021272",
  appId: "1:219937021272:web:8f240b170a557d0224592d",
  measurementId: "G-V7891ZWWVF"
};

// Firebase 초기화
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ====== 탭 전환 ======
document.querySelectorAll('.tab').forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll('section').forEach(s=>s.classList.add('hidden'));
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    btn.classList.add('active');
    document.querySelector('#tab-'+btn.dataset.tab).classList.remove('hidden');
  };
});

// ====== 타이머 ======
let timerInt=null,acc=0,startT=0;
const timeEl=document.getElementById("time");
function renderTime(ms){
  const s=Math.floor(ms/1000);
  const h=Math.floor(s/3600),m=Math.floor((s%3600)/60),sec=s%60;
  timeEl.textContent=`${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
}
document.getElementById("btnStart").onclick=()=>{
  if(timerInt) return;
  startT=Date.now();
  timerInt=setInterval(()=>{renderTime(acc+Date.now()-startT)},500);
};
document.getElementById("btnPause").onclick=()=>{
  if(!timerInt) return;
  acc+=Date.now()-startT; clearInterval(timerInt); timerInt=null;
};
document.getElementById("btnSave").onclick=()=>{
  if(timerInt){acc+=Date.now()-startT; clearInterval(timerInt); timerInt=null;}
  alert("기록 저장 완료!"); acc=0; renderTime(0);
};
renderTime(0);

// ====== 카드 도감 기본 10칸 ======
const dexGrid=document.getElementById("dexGrid");
function renderDex(){
  dexGrid.innerHTML="";
  for(let i=1;i<=9;i++){
    const slot=document.createElement("div");slot.className="slot";
    const img=document.createElement("img");img.src="/images/day"+i+".jpg";img.alt="day"+i;
    slot.appendChild(img);dexGrid.appendChild(slot);
  }
  const spec=document.createElement("div");spec.className="slot";
  const img=document.createElement("img");img.src="/images/specialcard.jpg";spec.appendChild(img);
  dexGrid.appendChild(spec);
}
renderDex();

// ====== 여행 완료 버튼 (위치 인증) ======
document.getElementById("btnClaimSpecial").onclick=()=>{
  if(!navigator.geolocation){alert("GPS 지원 안됨");return;}
  navigator.geolocation.getCurrentPosition(pos=>{
    const lat=pos.coords.latitude,lng=pos.coords.longitude;
    const targetLat=35.879388797,targetLng=128.628366313; // 동대구역
    const dist=getDistance(lat,lng,targetLat,targetLng);
    if(dist<=300) alert("위치 인증 성공! 대구 도착! 이제 당신의 키링을 만나보세요");
    else alert("위치 인증 실패: 동대구역 반경 300m 이내에서만 인증 가능합니다.");
  },()=>alert("위치 확인 불가"));
};
function getDistance(lat1,lng1,lat2,lng2){
  const R=6371e3;const toRad=x=>x*Math.PI/180;
  const φ1=toRad(lat1),φ2=toRad(lat2);
  const Δφ=toRad(lat2-lat1),Δλ=toRad(lng2-lng1);
  const a=Math.sin(Δφ/2)**2+Math.cos(φ1)*Math.cos(φ2)*Math.sin(Δλ/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

// ====== 문장 여행 (작성 & 승인된 문장 표시) ======
const userId=new URLSearchParams(location.search).get("id")||"anon";
document.getElementById("btnTripSend").onclick=async()=>{
  const text=document.getElementById("tripInput").value.trim();
  if(!text){alert("문장을 입력하세요");return;}
  await addDoc(collection(db,"sentences"),{id:userId,text,status:"pending",createdAt:new Date().toISOString(),isNotified:false});
  alert("승인 시 키링으로 제작되어 먼저 대구 여행 가 있을게요! 승인 or 반려는 2일 이내에 안내드립니다");
  document.getElementById("tripInput").value="";
};

// 승인된 문장만 불러오기
async function renderApproved(){
  const approvedDiv=document.getElementById("approvedList");
  const qSnap=await getDocs(query(collection(db,"sentences"),where("status","==","approved")));
  approvedDiv.innerHTML="";
  qSnap.forEach(docSnap=>{
    const d=docSnap.data();
    approvedDiv.innerHTML+=`<div class="feed-item">${d.text}<div class="notice">작성자: ${d.id}</div></div>`;
  });
}
renderApproved();

// 접속 시 내 문장이 승인됐는지 알림 (한 번만)
async function checkMyApproval(){
  if(!userId || userId==="anon") return;
  const qSnap=await getDocs(query(collection(db,"sentences"),where("id","==",userId)));
  qSnap.forEach(async(docSnap)=>{
    const d=docSnap.data();
    if(d.status==="approved" && !d.isNotified){
      alert(`✅ 승인된 문장: ${d.text}`);
      await updateDoc(doc(db,"sentences",docSnap.id),{isNotified:true});
    }
  });
}
checkMyApproval();

// ====== 관리자 (비밀번호 0000) ======
document.getElementById("btnAdminLogin").onclick=async()=>{
  const pass=document.getElementById("adminPass").value;
  if(pass!=="0000"){document.getElementById("adminError").textContent="비밀번호가 올바르지 않습니다.";return;}
  document.getElementById("adminPanel").classList.remove("hidden");
  loadPending();
};
async function loadPending(){
  const list=document.getElementById("pendingList");
  const qSnap=await getDocs(query(collection(db,"sentences"),where("status","==","pending")));
  list.innerHTML="";
  qSnap.forEach(docSnap=>{
    const d=docSnap.data();
    const el=document.createElement("div");el.className="feed-item";
    el.innerHTML=`${d.text} <div class="notice">작성자: ${d.id}</div>
    <button data-id="${docSnap.id}" class="btnReject">반려</button>
    <button data-id="${docSnap.id}" class="btnApprove">승인</button>`;
    list.appendChild(el);
  });
  document.querySelectorAll(".btnReject").forEach(b=>{
    b.onclick=async()=>{await deleteDoc(doc(db,"sentences",b.dataset.id));loadPending();};
  });
  document.querySelectorAll(".btnApprove").forEach(b=>{
    b.onclick=async()=>{
      await updateDoc(doc(db,"sentences",b.dataset.id),{status:"approved"});
      loadPending();
      renderApproved();
    };
  });
}
</script>
</body>
</html>
