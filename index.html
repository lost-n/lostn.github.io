<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>읽고 쓰고 떠나자!</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net"/>
<script src="https://unpkg.com/lucide@0.469.0/dist/umd/lucide.min.js"></script>
<style>
  /* ... (스타일 원본 그대로 유지) ... */
  .slot img{width:100%;height:100%;object-fit:contain;background:#fff;cursor:pointer}
</style>
</head>
<body>
<div class="wrap">
  <header><div class="head-inner"><div class="title">읽고 쓰고 떠나자!</div></div></header>

  <!-- 기록 (변경 없음) -->
  <section id="tab-app" class="section"> ... </section>

  <!-- 카드 도감 -->
  <section id="tab-cards" class="section hidden">
    <div class="panel">
      <h2>카드 도감</h2>
      <div id="dexGrid" class="grid"></div>
    </div>
  </section>

  <!-- 문장 여행 -->
  <section id="tab-trip" class="section hidden">
    <div class="stack">
      <div class="panel">
        <h2>문장 여행</h2>
        <textarea id="tripInput" class="textarea"></textarea>
        <button id="btnTripSend" class="btn primary" style="margin-top:10px;width:100%">보내기</button>
      </div>
      <div class="panel">
        <h2>우리들의 문장</h2>
        <div id="approvedList" class="feed"></div>
      </div>
    </div>
  </section>

  <!-- 관리자 (변경 없음) -->
  <section id="tab-admin" class="section hidden"> ... </section>

  <!-- 하단 네비 -->
  <nav class="bottom">
    <div class="tabs">
      <button class="tab active" data-tab="app"><i data-lucide="book-open"></i><span>기록</span></button>
      <button class="tab" data-tab="cards"><i data-lucide="album"></i><span>카드 도감</span></button>
      <button class="tab" data-tab="trip"><i data-lucide="lock"></i><span>문장 여행</span></button>
      <button class="tab" data-tab="admin"><i data-lucide="settings"></i><span>관리</span></button>
    </div>
  </nav>
</div>

<!-- 카드 팝업 -->
<div id="cardPopup" class="popup">
  <div class="popup-inner">
    <h3 style="margin-top:0">오늘의 카드</h3>
    <img id="popupImg" src="" alt="card"/>
    <div style="display:flex; gap:8px; margin-top:10px">
      <button id="popupCurious" class="btn primary" style="flex:1">궁금해요</button>
      <button id="popupClose" class="btn" style="flex:1">닫기</button>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  /* --- 기존 코드 유지 --- */

  const popup=document.getElementById("cardPopup");
  const popupImg=document.getElementById("popupImg");
  const btnCurious=document.getElementById("popupCurious");
  const btnClose=document.getElementById("popupClose");
  const popupQueue=[];
  const curiosityMap={1:"./page15.html",2:"./page2.html",3:"./page21.html",4:"./page17.html",5:"./page12.html",6:"./page5.html",7:"./page6.html",8:"./page3.html"};
  let currentPopupDay=null;

  function showPopup(src,day=null){
    popupImg.src=src;
    currentPopupDay=day;
    if(day && curiosityMap[day]){
      btnCurious.style.display="";btnCurious.onclick=()=>{window.location.href=curiosityMap[day];}
      popupImg.onclick=()=>{window.location.href=curiosityMap[day];}
    }else{
      btnCurious.style.display="none";btnCurious.onclick=null;popupImg.onclick=null;
    }
    popup.classList.add('show');
  }

  btnClose.addEventListener("click",()=>{popup.classList.remove('show');if(popupQueue.length){const n=popupQueue.shift();showPopup(n.src,n.day)}});

  // 카드 도감
  const dexGrid=document.getElementById("dexGrid");
  function renderDex(){
    dexGrid.innerHTML="";
    for(let i=1;i<=9;i++){
      const slot=document.createElement("div");slot.className="slot";
      const img=new Image();
      if(i<=state.givenCount){
        img.src=(i===9)?"./specialcard.png":`./00${i}.png`;
        img.onclick=()=>{if(i<=8)showPopup(`./${i}.png`,i);}
      }else{img.src="./blankcard.png";}
      img.onload=()=>{slot.style.setProperty('--ar',`${img.naturalWidth||2}/${img.naturalHeight||3}`);slot.innerHTML="";slot.appendChild(img);}
      slot.appendChild(document.createTextNode(""));dexGrid.appendChild(slot);
    }
  }

  // 카드 지급
  function giveCardAfterSave(){
    const today=ymd();
    if(state.lastClaimDate===today){alert("오늘 카드는 이미 받았어요.");return;}
    if(state.givenCount<8){
      const next=state.givenCount+1;
      state.givenCount=next;state.lastClaimDate=today;persist();renderDex();
      popupQueue.push({src:`./${next}.png`,day:next});
      if(next===8){state.givenCount=9;persist();renderDex();popupQueue.push({src:"./specialcard.png"});}
      const f=popupQueue.shift();showPopup(f.src,f.day);
    }else if(state.givenCount===8){state.givenCount=9;state.lastClaimDate=today;persist();renderDex();showPopup("./specialcard.png");}
    else{alert("모든 카드를 수집했어요!");state.lastClaimDate=today;persist();}
  }

  /* --- 나머지 코드 그대로 --- */
});
</script>

<!-- Firebase 부분: 그대로 유지 -->
<script type="module">
  /* ... 원본 Firebase 코드 그대로 ... */
</script>
</body>
</html>
